name: Deploy to EC2

on:
    push:
        branches: ["main"]

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout source
              uses: actions/checkout@v3

            - name: Login to Docker Hub
              uses: docker/login-action@v2
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Build and Push Docker Image
              uses: docker/build-push-action@v4
              with:
                  context: .
                  push: true
                  # ğŸ‘‡ [ì¤‘ìš”] ë³¸ì¸ ë„ì»¤ í—ˆë¸Œ ì•„ì´ë””ë¡œ ë³€ê²½
                  tags: ${{ secrets.DOCKER_USERNAME }}/blog_backend:latest

            - name: Deploy to EC2
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ubuntu
                  key: ${{ secrets.EC2_KEY }}
                  script: |
                      # ìµœì‹  ì´ë¯¸ì§€ ë°›ê¸°
                      # ğŸ‘‡ [ì¤‘ìš”] ë³¸ì¸ ë„ì»¤ í—ˆë¸Œ ì•„ì´ë””ë¡œ ë³€ê²½
                      docker pull ${{ secrets.DOCKER_USERNAME }}/blog_backend:latest

                      # ì»¨í…Œì´ë„ˆ ì¬ì‹¤í–‰ (ì•Œì•„ì„œ ìƒˆ ì´ë¯¸ì§€ë¡œ ê°ˆì•„ë¼ì›€)
                      docker compose down
                      docker compose up -d

                      # ì°Œêº¼ê¸° ì´ë¯¸ì§€ ì²­ì†Œ
                      docker image prune -f
